kahpp:
  group: test
  name: basic-transformations
  topics:
    source: kahpp-input
    sink: kahpp-output-success
    error: kahpp-output-error
  streamsConfig:
    bootstrapServers:
    - kafka:9092
    properties:
      "num.stream.threads": 1
      "commit.interval.ms": 0
  apis:
    my-dummy-api:
      basePath: http://my-dummy-api
      options:
        rateLimit:
          requestsPerSecond: 20
          warmUpMillis: 2000
        connection:
          connectTimeoutMillis: 300
          socketTimeoutMs: 1500
  steps:
  - name: filterTombstone
    type: dev.vox.platform.kahpp.configuration.filter.FilterTombstone
    config:
      filterNot: 'true'
  - name: setDateTime
    type: dev.vox.platform.kahpp.configuration.transform.TimestampToValueTransform
    config:
      field: date_time
  - name: httpDoWhatever
    type: dev.vox.platform.kahpp.configuration.http.OkOrProduceError
    config:
      api: my-dummy-api
      path: /foo
      topic: error
      conditionalStep:
        enabled: true
        jmesPath: "value.bla == `true`"
#      responseHandler:
#        type: NO_OP
#      responseHandler:
#        type: RECORD_UPDATE
#        jmesPath: value.to.update
#      responseHandler:
#        type: RECORD_VALUE_REPLACE #default value
  - name: provokeErrorWithJMES
    type: dev.vox.platform.kahpp.configuration.predicate.PredicateOrProduceError
    config:
      # This configuration could also be:
      #     `jmesPath: "value.provokeError == null || value.provokeError == `false`"`
      #     either: right # default
      # meaning KaHPP should forward items without the provoke item field OR when it is
      # equals to false. This logic was inverted and it was working because the value (true)
      # was not between backtick.
      jmesPath: "value.provokeError == `true`"
      either: left
      topic: error
  - name: convertDateTime
    type: dev.vox.platform.kahpp.configuration.transform.ConvertZonedDateTimeFieldTransform
    config:
      field: value.date_time
      inputFormat: RFC_3339_LENIENT_MS_FORMATTER
      outputFormat: RFC_3339
  - name: produceRecordToSinkTopic
    type: dev.vox.platform.kahpp.configuration.topic.ProduceToTopic
    config:
      topic: sink
